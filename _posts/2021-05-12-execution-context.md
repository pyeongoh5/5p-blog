---
layout: post
title: Javascript 실행 컨텍스트
date: 2021-05-12 19:21:20 +0900
description: Javascript 실행 컨텍스트
img: # Add image post (optional)
fig-caption: # Add figcaption (optional)
tags: [javascript, execution context, 실행 문맥, 실행 컨텍스트]
---

# 서론

자바스크립트에 대해서 공부하다 보면, 가장 흔하게 볼 수 있는 키워드로 `호이스팅`, `클로저` 와 같은 개념들이 있다. 그리고 이것을 일반적으로 아래와 같이 정리 하고 있는 것 같다.

> **호이스팅** = 변수나 함수 선언이 함수 최상단으로 끌어 올려지는 것,<br> **클로저** = 선언된 렉시컬 스코프 밖에서 실행되어 선언된 렉시컬 스코프에 접근 할 수 있는것. (함수 안의 함수 라고도 하는 것 같다.)

<br>

하지만, 어떤 원리에 의해서 호이스팅이나 클로저와 같은 현상이 발생하는지는 잘 적혀있지 않은데, 이 개념이 함께 설명되기에는 설명하고자 했던 호이스팅이나 클로저보다 더 큰 범위이다 보니 글의 목적이 바뀌게 되기 때문인 것 같다.
호이스팅이나 클로저가 발생하는 현상에 대한 이유를 설명해주는 이 개념을 `실행 컨텍스트(execution context)`라고 한다.

> 실행 문맥, 실행 컨텍스트, execution context 라고도 한다.

<br>

# 실행 컨텍스트란

ECMAScript에서 실행 문맥이란 실행 가능한 코드를 형상화하고, 구분하는 스펙으로서 정의되고, 실제 런타임에서의 실행 문맥은 자바스크립트가 동작하기 위한 환경으로써 동작한다.
자바스크립트 엔진에서 실행 가능한 코드는 아래와 같다.

1. **전역 코드**: 전역 내에 존재하는 코드
2. **Eval 코드**: eval함수로써 실행되는 코드
3. **함수 코드**: 함수 내에 존재하는 코드

eval같은 경우에는 잘 사용되지 않고, 자바스크립트 엔진에 의해 최적화된 환경을 깨뜨리기 때문에 권장하지 않고, 일반적으로 실행 가능한 코드는 전역 코드와 함수 코드를 의미한다.

자바스크립트 엔진이 코드를 실행하기 위해선 아래와 같은 여러가지 정보를 알고 있어야한다.

- **변수**: 전역변수, 지역변수, 매개변수, 객체의 프로퍼티
- **함수 선언**
- **스코프**
- **this**

이러한 정보를 형상화하고 구분하기 위해서, 자바스크립트 엔진은 위 정보를 실행 컨텍스트로서 물리적 객체의 형태로 관리한다. 실행 컨텍스트는 전역과 함수로 구분될 수 있고, 각각 코드 실행 시점에 생성되었다가 마찬가지로 코드 실행이 끝나는 시점에 파기되고, 어플리케이션 실행 주기내에서 활성화된 실행 컨텍스트는 하나 뿐이며,(**하나만 존재한다는 것이 아닌 활성화 된 것은 하나뿐**) 코드에 의해 중첩되어 생성되는 실행 컨텍스트는 stack 자료구조로 관리된다.

실행 컨텍스트가 생성되고 소멸되기 까지의 과정을 살펴보자:

1. 제어권이 실행 가능한 코드로 옮겨지게 되면, 논리적 스택 구조를 가지는 새로운 실행 컨텍스트 스택이 생성된다.
2. 전역 코드로 제어권이 진입하면 전역 컨텍스트가 생성되고 실행 컨텍스트 스택에 쌓인다. 전역 실행 컨텍스트는 어플리케이션 생명주기와 명을 함께한다.
3. 함수가 호출되면, 해당 함수에 대한 실행 컨텍스트가 생성되며, 직전에 실행되었던 코드 블록의 실행 컨텍스트에 위에 쌓인다.
4. 함수의 실행이 끝나면, 해당 실행 컨텍스트를 파기하고 이전 실행 코드 블록의 실행 컨텍스트로 제어권을 반환한다.

## 3가지 객체

물리적인 실행 컨텍스트 객체 안에는 3가지 객체가 프로퍼티로 존재한다.

### VO (variable object)

실행 컨텍스트가 생성되면서 자바스크립트 엔진은 실행에 필요한 여러 정보를 담을 객체를 생성하고 이중 하나가 VO라고 불리는 객체이다. VO는 코드가 실행될 때 엔진에 의해 참조되며 코드에서는 접근할 수 없으며, 아래와 같은 정보를 담고있다.

- 변수
- 매개변수(parameter)와 인수정보(arguments)
- 함수 선언(함수 표현식은 제외)

VO는 실행 컨텍스트의 프로퍼티이기 때문에 값을 가지고 있으며, 이 값은 어떠한 다른 객체를 가리킨다. VO는 실행컨텍스트가 전역이냐 함수냐에 따라 다른데, 이는 전역과 함수간의 특징이 서로 다르기 때문이다. 대표적으로는 전역 코드에는 매개변수가 없지만 함수에는 매개변수가 있는 차이가 있다.

- 전역 실행 컨텍스트의 VO → GO ( Global Object ) → 전역코드에 선언된 변수와 함수를 프로퍼티로 가진다.
- 함수 실행 컨텍스트의 VO → AO ( Activation Object ) → 추가적으로 arguments 객체를 프로퍼티로 가진다.

#### # 호이스팅이 되는 이유

```javascript
// A: 함수 선언
function functionContext() {
  console.log(name);

  var name = "실행컨텍스트";
  var age = 31;
}
functionContext();

// B: 가상 객체
const executionContext = {
  VO: {
    AO: {
      variables: {
        name: undefined,
        age: undefined,
      },
      arguments: {},
    },
  },
};
```

위 예제처럼 `functionContext` 함수가 실행된다면, 함수 내 코드를 분석하여 `가상객체`라는 실행 컨텍스트가 생성된다.실제 런타임에서 코드가 실행되기 전이지만 실행에 필요한 정보는 실행 컨텍스트로써 생성되어 있기때문에, 런타임 시점에 해당 변수에 접근할 수 있으며 이것이 우리가 알고 있는 호이스팅이다.

### 스코프 체인 (scope chain)

스코프 체인은 일종의 리스트로 전역객체와 중첩된 함수의 스코프의 레퍼런스를 차례대로 저장하고 있다. 따라서 스코프 체인은 해당 전역 또는 함수가 참조할 수 있는 변수, 함수 선언 등의 정보를 담고 있는 전역 객체(GO), 또는 활성 객체(AO)의 리스트를 가리킨다.

> 스코프 체인은 식별자 중에서 전역객체를 제외한 객체가 아닌 식별자, 즉 변수를 검색하는 메커니즘이다.
> 식별자 중에서 변수가 아닌 객체의 프로퍼티를 검색하는 메커니즘은 프로토타입 체인이다.

엔진은 스코프 체인을 통해 렉시컬 스코프를 파악하고, 함수가 중첩 상태일 때 하위함수 내에서 상위 함수의 스코프와 전역 스코프까지 참조할 수 있다. 함수가 중첩되어 있으면, 중첩될 때마다 부모 함수의 스코프가 자식 함수의 스코프 체인에 포함된다. 함수 실행중에 변수를 만나면 그 변수를 현재 스코프, 즉 AO에서 검색해보고 실패하면 스코프 체인에 담겨진 순서대로 그 검색을 차례대로 이어가게 된다.

예를 들어 함수 내의 코드에서 변수를 참조하면 엔진은 스코프 체인의 첫번째 리스트가 가리키는 AO에 접근하여 변수를 검색하는데, 이 검색에 실패하게되면 체인의 다음 리스트가 가리키는 AO에 접근하여 검색을 실행하게되고, 이는 체인에 들어있는 모든 요소에서 순차적으로 실행된다. 이것이 스코프체인이라 부르는 이유이다.

### this value

this 프로퍼티에는 this값이 할당된다. 기본적으로는 전역객체를 가리키고 있으며, 이후에 함수 호출패턴에 의해 결정된다.

## 호이스팅

실행 컨텍스트가 생성되면 스코프 체인이 가장 먼저 생성된다. 그리고 이 스코프 체인에 담길 GO 혹은 AO가 생성되고 스코프 체인이 이 객체를 가리키게 된다. 그리고 이 객체에는 코드 내에 선언된 함수 선언, 변수등이 포함되어 있다. 그렇기 때문에 선언되기 이전에 위치에서 해당 변수에 접근할 수 있으며 이를 호이스팅이라고 한다.

## 클로져

생성된 VO 객체에 생성된 함수 객체는 `[[scope]]` 프로퍼티를 가지는데, 이는 함수 객체만 가지는 내부 프로퍼티로서 함수 객체가 실행되는 환경을 가리킨다. 따라서 현재 실행 컨텍스트의 스코프체인이 가리키고 있는 변수 객체를 값으로 가진다. 이 때문에 함수가 외부로 반환된 뒤 실행 되어도 기존에 선언된 시점의 스코프체인이 가리키는 변수 객체를 참조 할 수 있게 되며 이것을 클로저라고 부른다.

![closure]({{site.baseurl}}/assets/img/closure.png)
